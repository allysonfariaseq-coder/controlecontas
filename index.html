<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Compras</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f8f9fa;
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    form {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    form input, form select, form button {
      margin: 5px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    form button {
      background: #28a745;
      color: #fff;
      cursor: pointer;
      border: none;
    }
    .meses {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    .mes-card {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      width: 300px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 5px;
      background: #e9ecef;
      margin-top: 5px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #28a745;
      width: 0%;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Controle de Compras</h1>

  <form id="formCompra">
    <input type="text" id="descricao" placeholder="Descrição" required>
    <input type="number" id="valor" placeholder="Valor" step="0.01" required>
    <input type="date" id="data" required>

    <select id="tipoConta" required>
      <option value="">Selecione o tipo</option>
      <option value="cartao">Cartão de Crédito</option>
      <option value="fora">Fora do Cartão</option>
    </select>

    <select id="cartao" style="display:none;">
      <option value="">Selecione o cartão</option>
      <option value="Nubank">Nubank</option>
      <option value="Inter">Inter</option>
      <option value="C6">C6</option>
      <option value="Bradesco">Bradesco</option>
      <option value="Itaú">Itaú</option>
      <option value="Banco do Brasil">Banco do Brasil</option>
      <option value="PicPay">PicPay</option>
      <option value="Neon">Neon</option>
    </select>

    <input type="number" id="parcelas" placeholder="Parcelas" value="1" min="1">
    <button type="submit">Adicionar</button>
  </form>

  <h2>Acompanhamento Mensal</h2>
  <div id="meses" class="meses"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjwDPCfffi92Z0Qu-12zY_ZMUxySQDFNM",
      authDomain: "controle-contas-86adb.firebaseapp.com",
      projectId: "controle-contas-86adb",
      storageBucket: "controle-contas-86adb.firebasestorage.app",
      messagingSenderId: "349383116773",
      appId: "1:349383116773:web:c0aa127faf7979bc76510c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const form = document.getElementById("formCompra");
    const mesesDiv = document.getElementById("meses");
    const tipoConta = document.getElementById("tipoConta");
    const cartaoSelect = document.getElementById("cartao");
    const dataInput = document.getElementById("data");

    // sempre sugere a data de hoje
    dataInput.valueAsDate = new Date();

    tipoConta.addEventListener("change", () => {
      cartaoSelect.style.display = tipoConta.value === "cartao" ? "inline-block" : "none";
      cartaoSelect.required = tipoConta.value === "cartao";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const descricao = document.getElementById("descricao").value;
      const valor = parseFloat(document.getElementById("valor").value);
      const data = new Date(document.getElementById("data").value);
      const tipo = tipoConta.value;
      const cartao = tipo === "cartao" ? cartaoSelect.value : "Fora do Cartão";
      const parcelas = parseInt(document.getElementById("parcelas").value);

      for (let i = 0; i < parcelas; i++) {
        let dataParcela = new Date(data);
        dataParcela.setMonth(data.getMonth() + i);
        await db.collection("compras").add({
          descricao,
          valor: valor / parcelas,
          data: dataParcela.toISOString().split("T")[0],
          tipo,
          cartao,
          pago: false,
          parcela: `${i+1}/${parcelas}`
        });
      }
      form.reset();
      dataInput.valueAsDate = new Date();
    });

    db.collection("compras").onSnapshot(snapshot => {
      const compras = [];
      snapshot.forEach(doc => compras.push({ id: doc.id, ...doc.data() }));
      renderMeses(compras);
    });

    function renderMeses(compras) {
      mesesDiv.innerHTML = "";
      const agrupado = {};

      compras.forEach(c => {
        const mesAno = c.data.slice(0,7);
        if (!agrupado[mesAno]) agrupado[mesAno] = [];
        agrupado[mesAno].push(c);
      });

      Object.keys(agrupado).sort().forEach(mesAno => {
        const lista = agrupado[mesAno];
        const total = lista.reduce((s, c) => s + c.valor, 0);
        const pago = lista.filter(c => c.pago).reduce((s, c) => s + c.valor, 0);
        const restante = total - pago;
        const progresso = total > 0 ? (pago/total)*100 : 0;

        const card = document.createElement("div");
        card.className = "mes-card";
        card.innerHTML = `
          <h3>${mesAno}</h3>
          <p>Total: R$ ${total.toFixed(2)}</p>
          <p>Pago: R$ ${pago.toFixed(2)}</p>
          <p>Restante: R$ ${restante.toFixed(2)}</p>
          <div class="progress-bar"><div class="progress-fill" style="width:${progresso}%"></div></div>
          <ul>
            ${lista.map(c => `
              <li>
                <span>${c.descricao} (${c.cartao}) - R$ ${c.valor.toFixed(2)} ${c.parcela || ""}</span>
                <input type="checkbox" ${c.pago ? "checked":""} onchange="togglePago('${c.id}', this.checked)">
              </li>
            `).join("")}
          </ul>
        `;
        mesesDiv.appendChild(card);
      });
    }

    async function togglePago(id, checked) {
      await db.collection("compras").doc(id).update({ pago: checked });
    }
  </script>
</body>
</html>
