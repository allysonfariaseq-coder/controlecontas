<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Compras & Faturas</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4a90e2">

<style>
:root {
  --cor-primaria: #4a90e2;
  --cor-secundaria: #f5f7fa;
  --cor-borda: #ccc;
  --cor-texto: #333;
  --raio: 8px;
  --espaco: 10px;
}
body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  margin: 0;
  padding: 20px 0;
  background: var(--cor-secundaria);
  color: var(--cor-texto);
  display: flex;
  justify-content: center;
}
.container {
  background: white;
  border-radius: var(--raio);
  box-shadow: 0 3px 12px rgba(0,0,0,0.15);
  width: 90%;
  max-width: 700px;
  padding: 20px 25px;
}
h1 { text-align:center; color: var(--cor-primaria); margin-bottom: 20px; font-size:1.5rem; }
label { display:block; margin-top:var(--espaco); margin-bottom:3px; font-size:0.9rem; }
input, select, button { width:100%; padding:8px 10px; margin-bottom: var(--espaco); border:1px solid var(--cor-borda); border-radius:var(--raio); font-size:0.9rem; }
button { background: var(--cor-primaria); color:white; border:none; cursor:pointer; transition:0.3s; font-size:0.95rem; padding:8px 10px; }
button:hover { background:#357abd; }
.voltar-btn { background:#888; }
.voltar-btn:hover { background:#666; }

table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid var(--cor-borda); padding:6px; text-align:center; font-size:0.85rem; }
th { background:var(--cor-primaria); color:white; }

.totais { margin-top:15px; background:#f0f4fb; padding:12px; border-radius:var(--raio); font-size:0.9rem; }

.faturas-grid { display:flex; flex-wrap:wrap; gap:12px; margin-top:10px; }
.fatura-card { background:#e6f0fc; padding:10px; border-radius:8px; flex:1 1 calc(33% - 12px); min-width:160px; box-shadow:0 1px 5px rgba(0,0,0,0.1); cursor:pointer; transition:0.2s; }
.fatura-card:hover { background:#d4e4fc; }
.fatura-card strong { display:block; margin-bottom:4px; }

#detalhesMes { margin-top:10px; background:#f9f9f9; padding:10px; border-radius:8px; }
#detalhesMes h4 { margin-top:0; font-size:1rem; }
#detalhesMes ul { margin:5px 0 10px 15px; padding:0; font-size:0.85rem; }
.cartao-nubank{color:#8a05be;}
.cartao-inter{color:#4da1ff;}
.cartao-itau{color:#ff7b00;}
.cartao-santander{color:#d71c1c;}
.cartao-bb{color:#008000;}
.cartao-neo{color:#00b894;}
.cartao-fora{color:#666666;}
</style>
</head>
<body>

<div class="container">
<h1>Nova Compra</h1>

<label for="tipoCompra">Tipo de compra</label>
<select id="tipoCompra" onchange="atualizarCampoCartao()">
  <option value="cartao">Cart√£o</option>
  <option value="fora">Fora do Cart√£o</option>
</select>

<div id="divCartao">
  <label for="cartao">Cart√£o</label>
  <select id="cartao">
    <option value="">Selecione o cart√£o</option>
    <option value="Nubank">Nubank</option>
    <option value="Inter">Inter</option>
    <option value="Ita√∫">Ita√∫</option>
    <option value="Santander">Santander</option>
    <option value="BB">Banco do Brasil</option>
    <option value="Neo">Neo</option>
    <option value="Outros">Outros</option>
  </select>
</div>

<label for="valor">Valor da compra</label>
<input type="number" id="valor" placeholder="Ex: 120.50" step="0.01" min="0.01">

<label for="parcelas">Parcelas</label>
<input type="number" id="parcelas" min="1" value="1">

<label for="data">Data da compra</label>
<input type="date" id="data">

<label for="descricao">Descri√ß√£o (opcional)</label>
<input type="text" id="descricao" placeholder="Ex: supermercado, restaurante...">

<button onclick="adicionarCompra()">Adicionar</button>
<button onclick="pedirSenha()">Detalhamento ‚Üí</button>

<!-- Detalhamento abaixo do formul√°rio -->
<div class="detalhes">
  <table id="tabelaCompras">
    <thead>
      <tr>
        <th>Valor</th>
        <th>Cart√£o / Tipo</th>
        <th>Parcela</th>
        <th>Data</th>
        <th>Descri√ß√£o</th>
        <th>Excluir</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="totais">
    <h2 style="font-size:1rem;">Faturas Futuras</h2>
    <div class="faturas-grid" id="faturasMeses"></div>
    <div id="detalhesMes" class="hidden"></div>
  </div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let compras = JSON.parse(localStorage.getItem('compras')) || [];
const senha = "1234";

function salvar(){ localStorage.setItem('compras', JSON.stringify(compras)); }
function getDataHoje(){ return new Date().toISOString().split('T')[0]; }

function atualizarCampoCartao(){
  const tipo = document.getElementById('tipoCompra').value;
  document.getElementById('divCartao').style.display = tipo==='fora'?'none':'block';
}

function adicionarCompra(){
  const valorTotal = parseFloat(document.getElementById('valor').value);
  const tipo = document.getElementById('tipoCompra').value;
  const cartao = document.getElementById('cartao').value;
  const dataInicio = document.getElementById('data').value;
  const totalParcelas = parseInt(document.getElementById('parcelas').value)||1;
  const descricao = document.getElementById('descricao').value;

  if(!valorTotal || (tipo==='cartao' && !cartao) || !dataInicio){
    alert("Preencha corretamente valor, cart√£o (se for cart√£o) e data.");
    return;
  }

  const valorParcela = parseFloat((valorTotal/totalParcelas).toFixed(2));
  const dataBase = new Date(dataInicio);

  for(let i=0;i<totalParcelas;i++){
    const dataParcela = new Date(dataBase);
    dataParcela.setMonth(dataBase.getMonth()+i);
    compras.push({
      valor: valorParcela,
      cartao: tipo==='cartao'?cartao:'Fora do Cart√£o',
      data: dataParcela.toISOString().split('T')[0],
      descricao,
      parcelaAtual:i+1,
      totalParcelas,
      tipo
    });
  }

  salvar();
  alert("Compra adicionada com sucesso!");
  limparCampos();
  preencherTotais();
  preencherTabela();
}

function limparCampos(){
  document.getElementById('valor').value='';
  document.getElementById('cartao').value='';
  document.getElementById('descricao').value='';
  document.getElementById('data').value=getDataHoje();
  document.getElementById('parcelas').value=1;
}

function excluirCompra(i){
  const excluirTudo=confirm("Excluir TODA a compra (todas parcelas)? Cancelar para excluir s√≥ esta parcela.");
  if(excluirTudo){
    const compra=compras[i];
    compras=compras.filter(c=>!(c.descricao===compra.descricao && c.cartao===compra.cartao && c.tipo===compra.tipo));
  }else compras.splice(i,1);
  salvar();
  preencherTabela();
  preencherTotais();
}

function pedirSenha(){
  const entrada=prompt("Digite a senha para acessar o detalhamento completo:");
  if(entrada===senha){
    preencherTabela();
    preencherTotais();
  }else alert("Senha incorreta!");
}

function preencherTabela(){
  const tbody=document.querySelector('#tabelaCompras tbody');
  tbody.innerHTML='';
  compras.sort((a,b)=>new Date(b.data)-new Date(a.data));
  compras.forEach((c,i)=>{
    const classeCartao={
      'Nubank':'cartao-nubank',
      'Inter':'cartao-inter',
      'Ita√∫':'cartao-itau',
      'Santander':'cartao-santander',
      'BB':'cartao-bb',
      'Neo':'cartao-neo',
      'Fora do Cart√£o':'cartao-fora',
      'Outros':'cartao-fora'
    }[c.cartao]||'cartao-fora';

    const tr=document.createElement('tr');
    tr.innerHTML=`<td>R$ ${c.valor.toFixed(2)}</td>
                  <td class="${classeCartao}">${c.cartao}</td>
                  <td>${c.parcelaAtual}/${c.totalParcelas}</td>
                  <td>${c.data}</td>
                  <td>${c.descricao||'-'}</td>
                  <td><button onclick="excluirCompra(${i})">üóëÔ∏è</button></td>`;
    tbody.appendChild(tr);
  });
}

function preencherTotais(){
  const faturas={};
  compras.forEach(c=>{
    const [ano,mes]=c.data.split('-').map(Number);
    const chave=`${mes.toString().padStart(2,'0')}/${ano}`;
    if(!faturas[chave]) faturas[chave]={};
    faturas[chave][c.cartao]=(faturas[chave][c.cartao]||0)+c.valor;
  });

  const divF=document.getElementById('faturasMeses');
  divF.innerHTML=Object.entries(faturas)
    .sort(([a],[b])=>{
      const [ma,aa]=a.split('/').map(Number);
      const [mb,ab]=b.split('/').map(Number);
      return new Date(aa,ma-1)-new Date(ab,mb-1);
    })
    .map(([mes,objCartoes])=>{
      const totalMes=Object.values(objCartoes).reduce((a,b)=>a+b,0);
      return `<div class="fatura-card" onclick="mostrarDetalhesMes('${mes}')">
                <strong>${mes} - Total: R$ ${totalMes.toFixed(2)}</strong>
                ${Object.entries(objCartoes).map(([c,v])=>`<div>${c}: R$ ${v.toFixed(2)}</div>`).join('')}
              </div>`;
    }).join('');

  document.getElementById('detalhesMes').classList.add('hidden');
  document.getElementById('detalhesMes').innerHTML='';
}

function mostrarDetalhesMes(mesAno){
  const comprasMes=compras.filter(c=>{
    const [ano,mes]=c.data.split('-').map(Number);
    const chave=`${mes.toString().padStart(2,'0')}/${ano}`;
    return chave===mesAno;
  });

  let html=`<h4>Detalhes de ${mesAno}</h4>`;
  const tipos=[...new Set(comprasMes.map(c=>c.cartao))];
  tipos.forEach(tipo=>{
    html+=`<strong>${tipo}</strong><ul>`;
    comprasMes.filter(c=>c.cartao===tipo).forEach(c=>{
      html+=`<li>R$ ${c.valor.toFixed(2)} - Parcela ${c.parcelaAtual}/${c.totalParcelas} - ${c.descricao||'-'}</li>`;
    });
    html+=`</ul>`;
  });
  const detalhesDiv=document.getElementById('detalhesMes');
  detalhesDiv.innerHTML=html;
  detalhesDiv.classList.remove('hidden');
}

function exportarExcel(){
  const ws=XLSX.utils.json_to_sheet(compras);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Compras");
  XLSX.writeFile(wb,"compras.xlsx");
}

function exportarGoogle(){
  alert("Para Google Sheets: baixe em Excel e fa√ßa upload no Google Drive.");
}

document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('data').value=getDataHoje();
  atualizarCampoCartao();
  preencherTabela();
  preencherTotais();
});
</script>
</body>
</html>
